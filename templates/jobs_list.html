
{% extends "base.html" %}
{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
  <h1>Jobs</h1>
  <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
    <form method="GET" action="{{ url_for('list_jobs') }}" style="display: flex; gap: 0.5rem; align-items: center;">
      <input type="text" name="search" value="{{ search_query or '' }}" placeholder="Search by customer name..." style="padding: 0.5rem 1rem; border-radius: 8px; border: 2px solid #e2e8f0; font-size: 0.9rem; min-width: 250px;">
      <button type="submit" class="btn btn-primary" style="padding: 0.5rem 1rem;">Search</button>
      {% if search_query %}
        <a href="{{ url_for('list_jobs') }}" class="btn" style="padding: 0.5rem 1rem;">Clear</a>
      {% endif %}
    </form>
    <a href="{{ url_for('new_job') }}" class="btn btn-primary">➕ New Job</a>
  </div>
</div>

{% if jobs %}
<table>
  <thead>
    <tr>
      <th>Job #</th>
      <th>Type</th>
      <th>Customer</th>
      <th>Date</th>
      <th>Status</th>
      <th>Description</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
  {% for job in jobs %}
    <tr>
      <td>
        <div id="job-{{ job.id }}-number-container" style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: nowrap; white-space: nowrap;">
          <strong id="job-{{ job.id }}-number-display" style="white-space: nowrap;">{{ job.job_number or job.id }}</strong>
          <button onclick="editJobNumber({{ job.id }})" class="btn btn-small" style="font-size: 0.75rem; padding: 0.25rem 0.5rem; background: #f59e0b; color: white; border: none; white-space: nowrap;">Edit</button>
        </div>
        <form id="job-{{ job.id }}-number-form" method="POST" action="{{ url_for('update_job_field', job_id=job.id) }}?from=list_jobs" style="display: none; margin-left: 0.5rem;">
          <input type="hidden" name="field" value="job_number">
          <input type="hidden" name="from_page" value="list_jobs">
          <input type="text" name="value" value="{{ job.job_number or job.id }}" style="padding: 0.25rem 0.5rem; border-radius: 6px; border: 2px solid #e2e8f0; font-size: 0.85rem; width: 120px; color: #1c4283 !important; background: white !important;">
          <button type="submit" class="btn btn-small btn-primary" style="font-size: 0.75rem; padding: 0.25rem 0.5rem; margin-left: 0.25rem;">Save</button>
          <button type="button" onclick="cancelEditJobNumber({{ job.id }})" class="btn btn-small" style="font-size: 0.75rem; padding: 0.25rem 0.5rem;">Cancel</button>
        </form>
      </td>
      <td>
        {% if job.job_type %}
          {% if job.job_type|lower == 'repair' %}
            <span style="display: inline-block; padding: 0.25rem 0.75rem; background: #fee2e2; color: #991b1b; border-radius: 12px; font-size: 0.8rem; font-weight: 500;">
              {{ job.job_type }}
            </span>
          {% elif job.job_type|lower == 'service' %}
            <span style="display: inline-block; padding: 0.25rem 0.75rem; background: #dbeafe; color: #1e40af; border-radius: 12px; font-size: 0.8rem; font-weight: 500;">
              {{ job.job_type }}
            </span>
          {% else %}
            <span style="display: inline-block; padding: 0.25rem 0.75rem; background: #e2e8f0; border-radius: 12px; font-size: 0.8rem; font-weight: 500;">
              {{ job.job_type }}
            </span>
          {% endif %}
        {% else %}
          <span style="color: #a0aec0;">—</span>
        {% endif %}
      </td>
      <td><strong>{{ job.customer_name }}</strong></td>
      <td>{{ job.job_date|aus_date if job.job_date else '<span style="color: #a0aec0;">—</span>'|safe }}</td>
      <td>
        {% if job.status %}
          {% set status_colors = {'Open': '#1c4283', 'In Progress': '#8bb3df', 'Completed': '#8bb3df', 'Invoiced': '#223a87'} %}
          {% set bg_color = status_colors.get(job.status, '#cbd5e0') %}
          <span style="display: inline-block; padding: 0.25rem 0.75rem; background: {{ bg_color }}20; color: {{ bg_color }}; border-radius: 12px; font-size: 0.8rem; font-weight: 500;">
            {{ job.status }}
          </span>
        {% else %}
          <span style="color: #a0aec0;">—</span>
        {% endif %}
      </td>
      <td>
        {% if job.description %}
          <div style="max-width: 300px; font-size: 0.75rem; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; word-wrap: break-word;">
            {{ job.description }}
          </div>
        {% else %}
          <span style="color: #a0aec0;">—</span>
        {% endif %}
      </td>
      <td>
        <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: nowrap; white-space: nowrap;">
          <a class="btn btn-small btn-primary" href="{{ url_for('job_detail', job_id=job.id) }}" style="white-space: nowrap;">View →</a>
          <form method="post" action="{{ url_for('delete_job', job_id=job.id) }}" style="display: inline; white-space: nowrap;" onsubmit="return confirm('Are you sure you want to delete job #{{ job.job_number or job.id }}? This will delete parts and machines, but contacts will be preserved.');">
            <button type="submit" class="btn btn-small" style="background: #f56565; color: white; border: none; font-size: 0.8rem; padding: 0.5rem 0.75rem; white-space: nowrap;">Delete</button>
          </form>
        </div>
      </td>
    </tr>
  {% endfor %}
  </tbody>
</table>
{% else %}
<div class="empty-state">
  {% if search_query %}
    <p style="font-size: 1.1rem; margin-bottom: 1rem;">No jobs found matching "{{ search_query }}".</p>
    <a href="{{ url_for('list_jobs') }}" class="btn">Clear Search</a>
  {% else %}
    <p style="font-size: 1.1rem; margin-bottom: 1rem;">No jobs yet.</p>
    <a href="{{ url_for('new_job') }}" class="btn btn-primary">Create Your First Job</a>
  {% endif %}
</div>
{% endif %}

<script>
function editJobNumber(jobId) {
  const container = document.getElementById('job-' + jobId + '-number-container');
  const form = document.getElementById('job-' + jobId + '-number-form');
  
  if (container && form) {
    container.style.display = 'none';
    form.style.display = 'inline-block';
    const input = form.querySelector('input[name="value"]');
    if (input) {
      input.focus();
      input.select();
    }
  }
}

function cancelEditJobNumber(jobId) {
  const container = document.getElementById('job-' + jobId + '-number-container');
  const form = document.getElementById('job-' + jobId + '-number-form');
  
  if (container && form) {
    container.style.display = 'inline-block';
    form.style.display = 'none';
  }
}
</script>
{% endblock %}
